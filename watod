#!/usr/bin/env bash
# Copyright (c) 2025-present WATonomous. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# Copyright (c) 2025‑present WATonomous.
# SPDX‑License‑Identifier: Apache‑2.0
set -euo pipefail

programname="$(basename "$(test -L "$0" && readlink "$0" || echo "$0")")"
MONO_DIR="$(cd -- "$(dirname -- "$(realpath "$0")")" && pwd)"
MODULES_DIR="$MONO_DIR/modules"

# ANSI color codes
readonly BLUE='\033[0;34m'
readonly GREEN='\033[0;32m'
readonly CYAN='\033[0;36m'
readonly YELLOW='\033[0;33m'
readonly RESET='\033[0m'
readonly BOLD='\033[1m'

# Always arrays → safe to expand with "${arr[@]}"
declare -a PROFILES=()
declare -a COMPOSE_CMD=()

usage() {
  cat <<EOF
Usage: $programname [OPTIONS]... [COMMAND]...

Executes 'docker compose COMMAND' in the monorepo with the correct
compose files and environment variables.

Options
  -v, --verbose               Print env setup output
  -t, --terminal SERVICE      Run 'docker compose up -d' (if needed) and open
                              a bash shell in the SERVICE container
  -h, --help                  Show this help and exit

Commands
  test [SERVICE]...           Run colcon test in specified service(s)
                              If no SERVICE specified, runs in all services
  bag <ros2-bag-args>...      Run ros2 bag commands (record/play/info/etc)
                              Runs in ./bags directory with auto-mounting

Examples
  watod up                    # docker compose up
  watod ps --services         # docker compose ps --services
  watod --all build           # docker compose build for all modules
  watod -t perception         # open a shell in the 'perception' service
  watod test                  # run tests in all services
  watod test perception       # run tests only in perception service
  watod bag record -a         # record all topics (auto-saves to ./bags)
  watod bag play my_bag       # play bag from ./bags directory
  watod bag info my_bag       # show bag info

More info: https://docs.docker.com/compose/reference/overview/
EOF
}

# Parse ACTIVE_MODULES and build profile arrays
# Input: ACTIVE_MODULES can contain "module" or "module:dev"
# Output: ALL_PROFILES, DEPLOY_PROFILES, DEV_PROFILES arrays
build_profile_arrays() {
  local blacklist=${1:-""}  # optional: space-separated list of modules to exclude

  ALL_PROFILES=()
  DEPLOY_PROFILES=()
  DEV_PROFILES=()

  # Ensure ACTIVE_MODULES is an array
  if [[ ! ${ACTIVE_MODULES@a} =~ a ]]; then
    read -ra ACTIVE_MODULES <<<"${ACTIVE_MODULES[*]}"
  fi

  for m in "${ACTIVE_MODULES[@]}"; do
    local module_name="$m"
    local is_dev=false

    # Check if this is a dev module
    if [[ "$m" == *":dev" ]]; then
      module_name="${m%:dev}"
      is_dev=true
    fi

    # Skip if module is in blacklist
    if [[ -n "$blacklist" && " $blacklist " =~ \ $module_name\  ]]; then
      continue
    fi

    # Add to appropriate arrays
    if $is_dev; then
      ALL_PROFILES+=( --profile "$module_name-dev" )
      DEV_PROFILES+=( --profile "$module_name-dev" )
    else
      ALL_PROFILES+=( --profile "$module_name" )
      DEPLOY_PROFILES+=( --profile "$module_name" )
    fi
  done
}

run_compose() {
  cd "$MONO_DIR"

  # Build profile arrays once
  if [[ -z ${PROFILES_BUILT:-} ]]; then
    PROFILES_BUILT=1
    build_profile_arrays
  fi

  # Run with all profiles, all three compose files
  if [[ ${#ALL_PROFILES[@]} -gt 0 ]]; then
    DOCKER_BUILDKIT=${DOCKER_BUILDKIT:-1} \
      COMPOSE_BAKE=${COMPOSE_BAKE:-true} \
      docker compose -f modules/docker-compose.yaml -f modules/docker-compose.dep.yaml -f modules/docker-compose.dev.yaml "${ALL_PROFILES[@]}" "${COMPOSE_CMD[@]}"
  fi
}

down_compose() {
  cd "$MONO_DIR"

  # Build profile arrays once
  if [[ -z ${PROFILES_BUILT:-} ]]; then
    PROFILES_BUILT=1
    build_profile_arrays
  fi

  # Bring down all containers at once
  if [[ ${#ALL_PROFILES[@]} -gt 0 ]]; then
    DOCKER_BUILDKIT=${DOCKER_BUILDKIT:-1} \
      COMPOSE_BAKE=${COMPOSE_BAKE:-true} \
      docker compose -f modules/docker-compose.yaml -f modules/docker-compose.dep.yaml -f modules/docker-compose.dev.yaml "${ALL_PROFILES[@]}" down
  fi
}

# ─────────────────────────── Argument parsing ────────────────────────────

[[ $# -eq 0 ]] && usage && exit 0

while [[ $# -gt 0 ]]; do
  case $1 in
    -v|--verbose)
      VERBOSE=1
      shift
      ;;
    -t|--terminal)
      START_TERMINAL=1
      shift
      SERVICE_NAME=${1:-}
      [[ -z $SERVICE_NAME ]] && { echo "Missing service name after -t"; usage; }
      shift
      ;;
    -h|--help|help)
      usage; exit 0 ;;
    test)
      RUN_TESTS=1
      shift
      # Collect service names if provided
      declare -a TEST_SERVICES=()
      while [[ $# -gt 0 && ! "$1" =~ ^- ]]; do
        TEST_SERVICES+=("$1")
        shift
      done
      break ;;
    bag)
      RUN_BAG=1
      shift
      # Pass all remaining arguments to watod-bag.sh
      BAG_ARGS=( "$@" )
      break ;;
    *)  # first non‑option → rest is docker‑compose cmd
      break ;;
  esac
done

# The remaining CLI words are the compose sub‑command and its flags
COMPOSE_CMD=( "$@" )

# ─────────────────────────── Environment setup ───────────────────────────

# Local overrides
[[ -f "$MONO_DIR/watod-config.local.sh" ]] && source "$MONO_DIR/watod-config.local.sh"
[[ -f "$MONO_DIR/watod-config.sh"       ]] && source "$MONO_DIR/watod-config.sh"

# Generate .env via helper script
if [[ -n ${VERBOSE:-} ]]; then
    pushd "$MONO_DIR" > /dev/null
    source ./watod_scripts/watod-setup-env.sh          # env vars persist
    popd > /dev/null
else
    pushd "$MONO_DIR" > /dev/null
    source ./watod_scripts/watod-setup-env.sh &>/dev/null
    popd > /dev/null
fi

# ────────────────────────────── Run Tests ────────────────────────────────

if [[ -n ${RUN_TESTS:-} ]]; then
  # First, build all services to ensure images are up-to-date
  echo "Building images before running tests..."
  COMPOSE_CMD=( build )
  run_compose

  # Build test profiles array, excluding simulation and infrastructure
  build_profile_arrays "simulation infrastructure"

  # Call the test script with profiles array as arguments
  if [[ ${#TEST_SERVICES[@]} -gt 0 ]]; then
    "$MONO_DIR/watod_scripts/watod-test.sh" -f modules/docker-compose.yaml "${ALL_PROFILES[@]}" "${TEST_SERVICES[@]}"
  else
    "$MONO_DIR/watod_scripts/watod-test.sh" -f modules/docker-compose.yaml "${ALL_PROFILES[@]}"
  fi
  exit $?
fi

# ────────────────────────────── Run Bag ──────────────────────────────

if [[ -n ${RUN_BAG:-} ]]; then
  # Export variables needed by watod-bag.sh
  export MONO_DIR MODULES_DIR BAG_DIRECTORY INFRASTRUCTURE_IMAGE TAG
  export RMW_IMPLEMENTATION CYCLONEDDS_URI ROS_DOMAIN_ID COMPOSE_PROJECT_NAME
  "$MONO_DIR/watod_scripts/watod-bag.sh" "${BAG_ARGS[@]}"
  exit $?
fi

# ─────────────────────────── Execute compose ─────────────────────────────

if [[ ${#COMPOSE_CMD[@]} -gt 0 ]]; then
  # Always run 'up' in detached mode since we run multiple compose commands
  if [[ "${COMPOSE_CMD[0]}" == "up" && ! "${COMPOSE_CMD[*]}" =~ -d ]]; then
    COMPOSE_CMD+=( -d )

    echo ""
    echo -e "${BLUE}╔═══════════════════════════════════════════════════════════╗${RESET}"
    echo -e "${BLUE}║${RESET}  ${BOLD}Starting WATonomous Services${RESET}                             ${BLUE}║${RESET}"
    echo -e "${BLUE}╠═══════════════════════════════════════════════════════════╣${RESET}"
    echo -e "${BLUE}║${RESET}  ${GREEN}Foxglove:${RESET}    ${CYAN}ws://localhost:${FOXGLOVE_BRIDGE_PORT}${RESET}                        ${BLUE}║${RESET}"
    echo -e "${BLUE}║${RESET}  ${GREEN}Log Viewer:${RESET}  ${CYAN}http://localhost:${LOG_VIEWER__PORT}${RESET}                      ${BLUE}║${RESET}"
    echo -e "${BLUE}╠═══════════════════════════════════════════════════════════╣${RESET}"
    echo -e "${BLUE}║${RESET}  ${YELLOW}View container logs at the Log Viewer URL above.${RESET}         ${BLUE}║${RESET}"
    echo -e "${BLUE}║${RESET}  Use ${BOLD}./watod down${RESET} to stop all services.                  ${BLUE}║${RESET}"
    echo -e "${BLUE}╚═══════════════════════════════════════════════════════════╝${RESET}"
    echo ""
  fi

  run_compose
fi

# Open interactive shell if requested
if [[ -n ${START_TERMINAL:-} ]]; then
  echo "Starting bash shell in service '$SERVICE_NAME'..."
  run_compose exec "$SERVICE_NAME" /bin/bash
fi
