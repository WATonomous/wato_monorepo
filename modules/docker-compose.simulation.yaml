version: "3.8"

services:
  carla_sim:
    build:
      context: ..
      dockerfile: docker/simulation/carla_sim/carla_sim.Dockerfile
      cache_from:
        - "${SIMULATION_CARLA_IMAGE:?}:${TAG}"
        - "${SIMULATION_CARLA_IMAGE:?}:main"
      target: build
      args:
        - CARLA_VERSION=0.9.13
    image: "${SIMULATION_CARLA_IMAGE:?}:${TAG}"
    environment:
      - DISPLAY=1
      - CUDA_VISIBLE_DEVICES=0,1,2
      - NVIDIA_VISIBLE_DEVICES=0,1,2
    security_opt:
      - seccomp:${MONO_DIR}/modules/seccomp_profile.json 
    runtime: nvidia
    restart: always
    command: /bin/bash -c "./CarlaUE4.sh -nosound -carla-server -RenderOffscreen -world-port=2000 -quality-level=Low"
