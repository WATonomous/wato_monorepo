version: "3.8"

services:
  carla_sim:
    build:
      context: ..
      dockerfile: docker/simulation/carla_sim/carla_sim.Dockerfile
      cache_from:
        - "${SIMULATION_CARLA_IMAGE:?}:${TAG}"
        - "${SIMULATION_CARLA_IMAGE:?}:main"
      args:
        - CARLA_VERSION=0.9.13
    image: "${SIMULATION_CARLA_IMAGE:?}:${TAG}"
    environment:
      - DISPLAY=1
      - CUDA_VISIBLE_DEVICES=0,1,2
      - NVIDIA_VISIBLE_DEVICES=0,1,2
    security_opt:
      - seccomp:${MONO_DIR}/modules/seccomp_profile.json 
    runtime: nvidia
    restart: always
    command: /bin/bash -c "./CarlaUE4.sh -nosound -carla-server -RenderOffscreen -world-port=2000 -quality-level=Low"
    
  carla_ros_bridge:
    build:
      context: ..
      dockerfile: docker/simulation/carla_ros_bridge/carla_ros_bridge.Dockerfile
      cache_from:
        - "${SIMULATION_CARLA_ROS_BRIDGE_IMAGE:?}:${TAG}"
        - "${SIMULATION_CARLA_ROS_BRIDGE_IMAGE:?}:main"
      target: deploy
      args:
        - CARLA_VERSION=0.9.13
    image: "${SIMULATION_CARLA_ROS_BRIDGE_IMAGE}:${TAG}"
    environment:
      - CARLA_HOSTNAME=${COMPOSE_PROJECT_NAME:?}-carla_sim-1
      - USE_ACKERMANN_CONTROL=False
    security_opt:
      - seccomp:${MONO_DIR}/modules/seccomp_profile.json
    command: /bin/bash -c "echo CARLA_ROS_BRIDGE disabled"
    # command: /bin/bash -c "ros2 launch carla_config carla.launch.py"

  carla_viz:
    build:
      context: ..
      dockerfile: docker/simulation/carla_viz/carla_viz.Dockerfile
      cache_from: 
        - "${SIMULATION_CARLAVIZ_IMAGE:?}:${TAG:?}" 
        - "${SIMULATION_CARLAVIZ_IMAGE:?}:develop"
      args:
        - CARLA_VERSION=0.9.13
    image: "${SIMULATION_CARLAVIZ_IMAGE:?}:${TAG:?}"
    ports:
      - ${CARLAVIZ_PORT}:8080
      - ${CARLAVIZ_PORT_2}:8081
    environment:
      - CARLA_SERVER_HOST=${COMPOSE_PROJECT_NAME:?}-carla_sim-1
      - CARLAVIZ_BACKEND_PORT=${CARLAVIZ_PORT_2}
    entrypoint: ["/bin/bash", "-c", "./docker/carlaviz_entrypoint.sh  > /dev/null 2>&1"]
    restart: always
