version: "3.8"

x-fixuid: &fixuid
  build:
    target: build

services:
  carla_sim:
    # <<: *fixuid
    extends:
      file: ../docker-compose.simulation.yaml
      service: carla_sim
#     command: tail -F anything
#     volumes:
#       - ${MONO_DIR}/src/simulation/carla_sim:/home/bolty/ament_ws/src/carla_sim
  carla_ros_bridge:
    <<: *fixuid
    extends:
      file: ../docker-compose.simulation.yaml
      service: carla_ros_bridge
    command: tail -F anything
    # volumes:
      # - ${MONO_DIR}/src/simulation/carla_sim:/home/bolty/ament_ws/src/carla_sim
  carla_viz:
    # <<: *fixuid
    extends:
      file: ../docker-compose.simulation.yaml
      service: carla_viz
#     command: tail -F anything
#     volumes:
#       - ${MONO_DIR}/src/simulation/carla_sim:/home/bolty/ament_ws/src/carla_sim
  carla_notebooks:
    build:
      context: ../..
      dockerfile: docker/simulation/carla_notebooks/carla_notebooks.Dockerfile
      cache_from: 
        - "${SIMULATION_CARLA_NOTEBOOKS_IMAGE:?}:${TAG:?}"
        - "${SIMULATION_CARLA_NOTEBOOKS_IMAGE:?}:develop"
      args:
        - CARLA_VERSION=0.9.13
    image: "${SIMULATION_CARLA_NOTEBOOKS_IMAGE:?}:${TAG:?}"
    ports:
      - ${CARLA_NOTEBOOKS_PORT:?}:${CARLA_NOTEBOOKS_PORT:?}
    environment:
      - CLIENT_NAME=${COMPOSE_PROJECT_NAME:?}-carla_sim-1
      - SCENARIO_RUNNER_ROOT=/home/bolty/scenario_runner
      - DISPLAY=1
      - CUDA_VISIBLE_DEVICES=0
      - NVIDIA_VISIBLE_DEVICES=1
    container_name: ${COMPOSE_PROJECT_NAME:?}_carla_notebooks
    volumes:
      - ../../src/simulation/carla_notebooks:/home/bolty/carla_notebooks
    command: jupyter notebook --allow-root --ip=0.0.0.0 --port=${CARLA_NOTEBOOKS_PORT:?} --no-browser --ServerApp.token='' --ServerApp.password=''
