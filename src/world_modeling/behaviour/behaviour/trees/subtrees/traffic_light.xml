<root BTCPP_format="4" main_tree_to_execute="TrafficLightSubTree">
    <BehaviorTree ID="TrafficLightSubTree">
        <Sequence name="Handle Traffic Light">

            <!-- WALL OF DOOM: compute stop/yield-line pose and spawn wall -->
            <GetStopLinePose
                reg_elem="{traffic_light}"
                lane_ctx="{@current_lane_ctx}"
                map_frame="{@map_frame}"
                pose="{traffic_light.wall_pose}"
                error_message="{traffic_light.get_stop_line_pose_error_msg}" />

            <GetWorldObjects
                objects="{traffic_light.objects}"
                error_message="{traffic_light.get_objects_error_msg}"
                service_name="/world_modeling/get_dynamic_objects" />

            <!-- Get the state of the traffic light -->
            <GetTrafficLightState
                traffic_light="{traffic_light}"
                objects="{traffic_light.objects}"
                state_hypothesis_index="{@bt.traffic_light_state_hypothesis_index}"
                out_traffic_light_state="{traffic_light.state}"
                error_message="{get_traffic_light_state_error_msg}" />

            <!-- Act based on state -->
            <Fallback name="Traffic Light Gate">
                <!-- RED or YELLOW or UNKNOWN=> ensure wall is spawned -->
                <Sequence name="RedOrYellow">
                    <Fallback name="RedOrYellowCheck">
                        <IsTrafficLightState traffic_light_state="{traffic_light.state}"
                            expected="red" />
                        <IsTrafficLightState traffic_light_state="{traffic_light.state}"
                            expected="yellow" />
                    </Fallback>

                    <SpawnWall
                        pose="{traffic_light.wall_pose}"
                        tf_buffer="{@tf_buffer}"
                        pose_frame="{@map_frame}"
                        width="{@bt.intersection_wall_of_doom_width}"
                        length="{@bt.intersection_wall_of_doom_length}"
                        wall_id="{traffic_light.wall_id}"
                        error_message="{traffic_light.spawn_wall_error_msg}" />
                </Sequence>

                <!-- GREEN => despawn wall if it exists (idempotent) -->
                <Sequence name="Green">
                    <IsTrafficLightState traffic_light_state="{traffic_light.state}"
                        expected="green" />

                    <DespawnWall wall_id="{traffic_light.wall_id}"
                        error_message="{traffic_light.despawn_wall_error_msg}" />
                </Sequence>

                <!-- UNKNOWN => fail-safe: spawn wall -->
            </Fallback>
            <SpawnWall
                pose="{traffic_light.wall_pose}"
                tf_buffer="{@tf_buffer}"
                pose_frame="{@map_frame}"
                width="{@bt.intersection_wall_of_doom_width}"
                length="{@bt.intersection_wall_of_doom_length}"
                wall_id="{traffic_light.wall_id}"
                error_message="{traffic_light.spawn_wall_error_msg}" />
            <!-- TODO: Add condition to see if passed intersection -->
        </Sequence>
    </BehaviorTree>

</root>
