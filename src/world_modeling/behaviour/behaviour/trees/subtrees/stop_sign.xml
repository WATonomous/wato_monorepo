<root BTCPP_format="4" main_tree_to_execute="StopSignSubTree">

    <BehaviorTree ID="StopSignSubTree">
        <Sequence name="Handle Stop Sign">
            <!-- PLACEHOLDER for WALL OF DOOM -->
            <ExecuteBehaviour behaviour="spawn_wall" topic_name="/execute_behaviour" />

            <EgoStopped ego_velocity="{ego_velocity}" threshold_velocity="0.10" />

            <!-- Fetch lanelets controlled by this regulatory element -->
            <ReactiveSequence>
                <GetLaneletsByRegElem reg_elem_id="{active_traffic_control_element_id}"
                    lanelets="{stop_sign.lanelets}"
                    error_message="{get_lanelets_by_reg_elem_error_msg}" />

                <!-- Current cars near stop line(s) on yield lanelets -->
                <GetStopSignCars stop_sign="{active_traffic_control_element}"
                    lanelets="{stop_sign.lanelets}"
                    threshold_m="8.0"
                    dynamic_objects_snapshot="{dynamic_objects.snapshot}"
                    out_stop_sign_car_ids="{stop_sign.current_ids}" />

                <!-- Latch baseline priority set (wire output back into the same BB key) -->
                <SetStopSignPriorityCars
                    current_car_ids="{stop_sign.current_ids}"
                    priority_car_ids="{stop_sign.priority_ids}"
                    priority_latched="{stop_sign.priority_latched}"
                    out_priority_car_ids="{stop_sign.priority_ids}"
                    out_priority_latched="{stop_sign.priority_latched}"
                />

                <!-- Can proceed if priority ids no longer appear in current ids -->
                <StopSignCanProceed priority_ids="{stop_sign.priority_ids}"
                    current_ids="{stop_sign.current_ids}" />
            </ReactiveSequence>

            <!-- PLACEHOLDER for WALL OF DOOM -->
            <ExecuteBehaviour behaviour="despawn_wall" topic_name="/execute_behaviour" />

            <ClearStopSignPriorityCarsAction
                priority_car_ids="{stop_sign.priority_ids}"
                priority_latched="{stop_sign.priority_latched}" />

        </Sequence>
    </BehaviorTree>
</root>