<root BTCPP_format="4" main_tree_to_execute="StopSignSubTree">

    <BehaviorTree ID="StopSignSubTree">
        <Sequence name="Handle Stop Sign">

            <!-- WALL OF DOOM: compute stop-line pose and spawn wall -->
            <GetStopLinePose
                reg_elem="{active_traffic_control_element}"
                map_frame="{map_frame}"
                pose="{stop_sign.stop_line_pose}"
                error_message="{get_stop_line_pose_error_msg}" />

            <SpawnWall
                pose="{stop_sign.stop_line_pose}"
                tf_buffer="{@tf_buffer}"
                base_frame="{@base_frame}"
                width="5.0"
                length="1.0"
                wall_id="{stop_sign.wall_id}"
                error_message="{spawn_wall_error_msg}" />

            <EgoStopped ego_velocity="{ego_velocity}" threshold_velocity="0.10" />

            <!-- Temporal-based stop sign logic: track arrival times and determine right-of-way -->
            <ReactiveSequence>
                <!-- Get lanelets controlled by this regulatory element -->
                <GetLaneletsByRegElem
                    reg_elem_id="{active_traffic_control_element_id}"
                    lanelets="{stop_sign.lanelets}"
                    error_message="{get_lanelets_by_reg_elem_error_msg}" />

                <!-- Get cars with their detection timestamps -->
                <GetStopSignCarsWithTimestamps
                    stop_sign="{active_traffic_control_element}"
                    lanelets="{stop_sign.lanelets}"
                    threshold_m="8.0"
                    velocity_threshold_mps="0.5"
                    dynamic_objects_snapshot="{@dynamic_objects.snapshot}"
                    out_stop_sign_cars_with_timestamps="{stop_sign.cars_with_timestamps}" />

                <!-- Update arrival queue with current detections -->
                <UpdateStopSignArrivalQueue
                    current_cars_with_timestamps="{stop_sign.cars_with_timestamps}"
                    simultaneous_arrival_threshold_s="1.0"
                    arrival_queue="{stop_sign.arrival_queue}" />

                <!-- Check if ego has right-of-way based on arrival order -->
                <StopSignCheckRightOfWay
                    arrival_queue="{stop_sign.arrival_queue}"
                    ego_id="ego"
                    blocking_car_ids="{stop_sign.blocking_ids}" />
            </ReactiveSequence>

            <!-- WALL OF DOOM: despawn wall after proceed condition passes -->
            <DespawnWall
                wall_id="{stop_sign.wall_id}"
                error_message="{despawn_wall_error_msg}" />

            <!-- Mark ego as having proceeded (updates arrival queue) -->
            <MarkEgoProceeded
                arrival_queue="{stop_sign.arrival_queue}"
                ego_id="ego" />

            <!-- Clear arrival queue after successfully proceeding -->
            <ClearStopSignArrivalQueue
                arrival_queue="{stop_sign.arrival_queue}" />

        </Sequence>
    </BehaviorTree>
</root>
