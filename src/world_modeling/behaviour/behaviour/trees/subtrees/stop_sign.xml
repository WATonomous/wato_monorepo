<root BTCPP_format="4" main_tree_to_execute="StopSignSubTree">

    <BehaviorTree ID="StopSignSubTree">
        <Sequence name="Handle Stop Sign">

            <!-- WALL OF DOOM: compute stop-line pose and spawn wall -->
            <GetStopLinePose
                reg_elem="{active_traffic_control_element}"
                map_frame="{@map_frame}"
                pose="{stop_sign.stop_line_pose}"
                error_message="{get_stop_line_pose_error_msg}" />

            <SpawnWall
                pose="{stop_sign.stop_line_pose}"
                tf_buffer="{@tf_buffer}"
                pose_frame="{@map_frame}"
                width="{@bt.intersection_wall_of_doom_width}"
                length="{@bt.intersection_wall_of_doom_length}"
                wall_id="{stop_sign.wall_id}"
                error_message="{spawn_wall_error_msg}" />

            <EgoStopped ego_odom="{ego_odom}"
                threshold_velocity="{@bt.ego_stopped_velocity_threshold}" />

            <!-- Fetch lanelets controlled by this regulatory element -->
            <ReactiveSequence>
                <GetLaneletsByRegElem
                    reg_elem_id="{active_traffic_control_element_id}"
                    lanelets="{stop_sign.lanelets}"
                    error_message="{get_lanelets_by_reg_elem_error_msg}" />

                <GetObjects
                    objects="{stop_sign.objects}"
                    error_message="{get_objects_error_msg}"
                    service_name="/world_modeling/get_dynamic_objects" />

                <GetStopSignCars
                    stop_sign="{active_traffic_control_element}"
                    objects="{stop_sign.objects}"
                    hypothesis_index="{@world_objects_hypothesis_index}"
                    stop_sign_line_threshold_m="{@bt.stop_sign_car_detection_threshold_m}"
                    out_stop_sign_car_ids="{stop_sign.current_ids}" />

                <SetStopSignPriorityCars
                    current_car_ids="{stop_sign.current_ids}"
                    priority_car_ids="{stop_sign.priority_ids}"
                    priority_latched="{stop_sign.priority_latched}"
                    out_priority_car_ids="{stop_sign.priority_ids}"
                    out_priority_latched="{stop_sign.priority_latched}" />

                <StopSignCanProceed
                    priority_ids="{stop_sign.priority_ids}"
                    current_ids="{stop_sign.current_ids}" />
            </ReactiveSequence>

            <!-- WALL OF DOOM: despawn wall after proceed condition passes -->
            <DespawnWall
                wall_id="{stop_sign.wall_id}"
                error_message="{despawn_wall_error_msg}" />

            <ClearStopSignPriorityCarsAction
                priority_car_ids="{stop_sign.priority_ids}"
                priority_latched="{stop_sign.priority_latched}" />

        </Sequence>
    </BehaviorTree>
</root>
