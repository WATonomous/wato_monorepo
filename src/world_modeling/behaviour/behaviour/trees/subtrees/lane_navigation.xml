<root BTCPP_format="4" main_tree_to_execute="LaneNavigationSubTree">
  <BehaviorTree ID="LaneNavigationSubTree">
    <Fallback name="Execute Navigation">
      <Sequence>
        <GetRouteContext route="{global_route}" route_index_map="{global_route_index_map}"
          lane_ctx="{@current_lane_ctx}" out_lane_transition="{upcoming_lane_transition}"
          out_next_lanelet="{target_lanelet}" />
        <Fallback name="Lane Transition Handling">
          <Sequence name="Handle SUCCESSOR Transition">
            <IsLaneTransition transition="{upcoming_lane_transition}" expected="SUCCESSOR" />
            <ExecuteBehaviour
              behaviour="follow route"
              preferred_lanelet_ids="{global_route_lanelet_ids}"
              topic_name="/execute_behaviour" />
          </Sequence>

          <Sequence name="Handle RIGHT Transition">
            <IsLaneTransition transition="{upcoming_lane_transition}" expected="RIGHT" />

            <!-- Is the lane change valid and safe? -->
            <ValidLaneChange
              transition="{upcoming_lane_transition}"
              lane_ctx="{@current_lane_ctx}" />

            <SafeLaneChange
              lane_transition="{upcoming_lane_transition}"
              area_occupancy_snapshot="{@area_occupancy.snapshot}" />

            <!-- If the lane change is valid, build the preferred lanelet IDs for the lattice
              planner -->
            <GetLaneChangePreferredLanelets
              lane_ctx="{@current_lane_ctx}"
              target_lanelet="{target_lanelet}"
              out_preferred_lanelet_ids="{right_lane_change_preferred_lanelet_ids}" />
            <ExecuteBehaviour
              behaviour="lane change right"
              preferred_lanelet_ids="{right_lane_change_preferred_lanelet_ids}"
              topic_name="/execute_behaviour" />
          </Sequence>

          <Sequence name="Handle LEFT Transition">
            <IsLaneTransition transition="{upcoming_lane_transition}" expected="LEFT" />

            <!-- Is the lane change valid and safe? -->
            <ValidLaneChange
              transition="{upcoming_lane_transition}"
              lane_ctx="{@current_lane_ctx}" />

            <SafeLaneChange
              lane_transition="{upcoming_lane_transition}"
              area_occupancy_snapshot="{@area_occupancy.snapshot}" />

            <!-- If the lane change is valid, build the preferred lanelet IDs for the lattice
              planner -->
            <GetLaneChangePreferredLanelets
              lane_ctx="{@current_lane_ctx}"
              target_lanelet="{target_lanelet}"
              out_preferred_lanelet_ids="{left_lane_change_preferred_lanelet_ids}" />
            <ExecuteBehaviour
              behaviour="lane change left"
              preferred_lanelet_ids="{left_lane_change_preferred_lanelet_ids}"
              topic_name="/execute_behaviour" />
          </Sequence>

        </Fallback>
      </Sequence>
      <Sequence>
        <GetFollowLanePreferredLanelets
          lane_ctx="{@current_lane_ctx}"
          out_preferred_lanelet_ids="{follow_lane_preferred_lanelet_ids}" />
        <ExecuteBehaviour
          behaviour="follow lane"
          preferred_lanelet_ids="{follow_lane_preferred_lanelet_ids}"
          topic_name="/execute_behaviour" />
      </Sequence>
    </Fallback>
  </BehaviorTree>
</root>