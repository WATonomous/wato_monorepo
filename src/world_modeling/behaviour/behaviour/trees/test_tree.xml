<root BTCPP_format="4" main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">
    <Fallback name="Root Fallback">
      
      <Sequence name="Core Navigation Sequence">
        <!-- Ensure goal exists -->
        <GoalExist point="{goal_point}"/>

        <!-- Ensure goal is not reached -->
        <Inverter>
          <GoalReached current_point="{ego_point}" goal_point="{goal_point}" threshold_m="1.0"/>
        </Inverter>

        <!-- Ensure path exists -->
        <Fallback name="Ensure Route">
          
          <Sequence name="IsGlobalRouteValid">
            <GlobalRouteExist route="{global_route}" />
            <CarOnRoute route_index_map="{global_route_index_map}" lane_ctx="{current_lane_ctx}"/>
          </Sequence>

          <Fallback name="Get Route">
            
            <GetShortestRoute route="{global_path}" route_index_map="{global_route_index_map}" error_message="{get_shortest_route_error_msg}" service_name="get_shortest_route"/>

            <Sequence name="Set Route">
              
              <Fallback name="CheckSpecificErrors">
                <IsErrorMessage msg="{get_shortest_route_error_msg}" expected="ego_not_on_route"/>
                <IsErrorMessage msg="{get_shortest_route_error_msg}" expected="no_active_route"/>
              </Fallback>

              <RetryUntilSuccessful num_attempts="10">
                <RateController hz="1.0">
                  <SetRoute goal_point="{goal_point}" service_name="set_route"/>
                </RateController>
              </RetryUntilSuccessful>
              
              <GetShortestRoute route="{global_path}" route_index_map="{global_route_index_map}" error_message="{get_shortest_route_error_msg}" service_name="get_shortest_route"/>
              
            </Sequence>
          </Fallback>

        </Fallback>

        <Fallback name="Execute Navigation">
          <Sequence>
            <GetRouteContext route="{global_route}" route_index_map="{global_route_index_map}" lane_ctx="{current_lane_ctx}" out_lane_transition="{upcoming_lane_transition}" out_next_lanelet="{target_lanelet}"/>
            <Fallback name="Lane Transition Handling">
              <Sequence name="Handle SUCCESSOR Transition">
                <IsLaneTransition transition="{upcoming_lane_transition}" expected="SUCCESSOR" />
                <ExecuteBehaviour behaviour="follow route" topic_name="/execute_behaviour"/>
              </Sequence>
              
              <Sequence name="Handle RIGHT Transition">
                <IsLaneTransition transition="{upcoming_lane_transition}" expected="RIGHT" />
                <ValidLaneChange transition="{upcoming_lane_transition" lane_ctx="{current_lane_ctx}"/>
                <ExecuteBehaviour behaviour="lane change right" topic_name="/execute_behaviour"/>
              </Sequence>
              
              <Sequence name="Handle LEFT Transition">
                <IsLaneTransition transition="{upcoming_lane_transition}" expected="LEFT" />
                <ValidLaneChange transition="{upcoming_lane_transition" lane_ctx="{current_lane_ctx}"/>
                <ExecuteBehaviour behaviour="lane change left" topic_name="/execute_behaviour"/>
              </Sequence>
              
            </Fallback>
          </Sequence>
          <ExecuteBehaviour behaviour="follow lane" preferred_lanelet_ids="{current_lanelet_ctx.upcoming_lanelet_ids}" topic_name="/execute_behaviour"/>
        </Fallback>
        <ExecuteBehaviour behaviour="navigate" topic_name="/execute_behaviour"/>
      </Sequence>

      <!-- If no goal exists or goal is reached or we failed to get route -->
      <ExecuteBehaviour behaviour="standby" topic_name="/execute_behaviour"/>

    </Fallback>
  </BehaviorTree>
</root>