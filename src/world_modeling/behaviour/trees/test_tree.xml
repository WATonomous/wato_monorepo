<root BTCPP_format="4" main_tree_to_execute="MainTree">
  <include path="subtrees/navigation.xml" />

  <BehaviorTree ID="MainTree">
    <ReactiveFallback name="root_fallback">
      <!-- 1. Do we have a goal -->

      <Sequence name="goal_reached_sequence">
        <Inverter>
          <HasGoal goal_point="{goal_point}" />
        </Inverter>
        <ExecuteBehaviour action_name="execute_behaviour" behaviour="standby" />
      </Sequence>

      <!-- 1. Goal Reached Check -->

      <Sequence name="goal_reached_sequence">

        <GoalReached
          current_point="{current_point}"
          goal_point="{goal_point}"
          threshold_m="1.0" />
        <ExecuteBehaviour action_name="execute_behaviour" behaviour="standby" />
      </Sequence>

      <!-- 2. Main mission logic (Simplified for testing) -->
      <Sequence name="main_behaviour">
        <Fallback name="route_management">
          <!-- Try to get the current route -->
          <GetRoute
            distance_m="100.0"
            path="{global_path}"
            error_message="{get_route_error_msg}"
            service_name="get_route"
          />

          <!-- If GetRoute fails, try to set a new route -->
          <Sequence name="set_route_sequence">
            <RetryUntilSuccessful num_attempts="5">
              <SetRoute
                  goal_point="{goal_point}"
                  goal_updated="{goal_updated}"
                  error_message="{error_msg}"
                  service_name="set_route"
              />
            </RetryUntilSuccessful>

            <GetRoute
              distance_m="100.0"
              path="{global_path}"
              error_message="{get_route_error_msg}"
              service_name="get_route"
            />
          </Sequence>
        </Fallback>

        <!-- Lane Navigation Logic -->
        <SubTree ID="Navigation"
                 global_path="{global_path}"
                 current_lane_context="{current_lane_context}"
                 current_point="{current_point}" />
      </Sequence>
    </ReactiveFallback>
  </BehaviorTree>
</root>
