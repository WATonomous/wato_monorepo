<root BTCPP_format="4">
  <BehaviorTree ID="intersection">
    <Sequence name="intersection_sequence">
      <!-- 1. Extract all upcoming regulatory elements from the planned path -->
      <GetRegElemContext
          path="{global_path}"
          lanelet_context="{current_lane_context}"
          reg_elems="{upcoming_reg_elems}" />

      <!-- 2. Check if we have reached the first regulatory element (threshold 5.0m) -->
      <!-- If successful, it captures the element into {active_reg_elem} -->
      <RegElemReached
          reg_elems="{upcoming_reg_elems}"
          threshold_m="5.0"
          selected_reg_elem="{active_reg_elem}" />

      <!-- 3. Branch based on the type of the reached regulatory element -->
      <Fallback name="reg_elem_handler_selector">

        <!-- Stop Sign Branch -->
        <Sequence name="stop_sign_branch">
          <RegElemType value="{active_reg_elem}" expected="stop_sign" />
          <!-- TODO(wato): improve yield when better world model services are implemented -->
          <SubTree ID="stop_sign" active_elem="{active_reg_elem}" />
        </Sequence>

        <!-- Traffic Light Branch -->
        <Sequence name="traffic_light_branch">
          <RegElemType value="{active_reg_elem}" expected="traffic_light" />
          <!-- TODO(wato): Implement traffic_light subtree (see traffic_light.xml) -->
          <AlwaysSuccess />
        </Sequence>

        <!-- Yield Branch -->
        <Sequence name="yield_branch">
          <RegElemType value="{active_reg_elem}" expected="yield" />
          <!-- TODO(wato): improve yield when better world model services are implemented -->
          <SubTree ID="yield" active_elem="{active_reg_elem}" />
        </Sequence>

      </Fallback>
    </Sequence>
  </BehaviorTree>
</root>
